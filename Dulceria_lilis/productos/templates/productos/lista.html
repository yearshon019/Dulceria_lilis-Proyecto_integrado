{% extends 'usuarios/base.html' %}
{% load static %}

{% block title %}Productos{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-box-seam"></i> Lista de Productos
    </h2>
    <div class="col-md-2 d-grid">
  <a class="btn btn-success" href="?export=xlsx">
    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
  </a>
</div>
  </div>
  
  <!-- TABLA CON BUSCADOR INTEGRADO -->
<div class="card shadow-sm mb-5">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">


      <!-- Buscador -->
      <form method="get" action="{% url 'productos:lista' %}" class="d-flex" id ="buscador" style="max-width: 400px;">
        <input type="text" name="buscar" class="form-control form-control-sm me-2"
               placeholder="Buscar por SKU o nombre"
               value="{{ buscar|default_if_none:'' }}"
               autocomplete="off">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-search"></i>
        </button>
      </form>
    </div>

<<<<<<< HEAD
=======
    <div class="col-md-2">
      <label class="form-label small fw-semibold">Por p치gina</label>
      <select name="pp" class="form-select" onchange="this.form.submit()">
        <option value="5"  {% if per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
        <option value="1500" {% if per_page == 1500 %}selected{% endif %}>1500</option>
      </select>
    </div>
>>>>>>> 04b2537 (todo casi todo casi casi casi casi todo)


    <!-- Tabla -->
    {% if productos %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-danger">
          <tr>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Stock actual</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for pr in productos %}
          <tr>
            <td>{{ pr.sku }}</td>
            <td>{{ pr.nombre }}</td>
            <td>
              {% if pr.alerta_bajo_stock %}
                <span class="text-danger fw-bold">{{ pr.stock_actual }}</span>
              {% else %}
                {{ pr.stock_actual }}
              {% endif %}
            </td>
            <td class="text-center">
              <a href="{% url 'productos:editar' pr.pk %}" class="btn btn-sm btn-warning" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{% url 'productos:detalle' pr.pk %}" class="btn btn-sm btn-info" title="Detalle">
                <i class="bi bi-info-circle"></i>
              </a>
              <button onclick="confirmarEliminacion('{{ pr.pk }}')" class="btn btn-sm btn-danger" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
    {% else %}
      {% if busqueda_activa %}
        <div class="alert alert-warning mb-0">
          No se encontraron productos para la b칰squeda: <strong>{{ buscar }}</strong>
        </div>
      {% else %}
      <div class="alert alert-info mb-0">No hay productos registrados.</div>
    {% endif %}
    {% endif %}
  </div>
<<<<<<< HEAD
=======

  <!-- 游 Formulario embebido (MANTENER IGUAL) -->
  <!-- 游 Formulario embebido -->
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background-color:#c62828;">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Formulario de Producto</h4>
        <img src="{% static 'img/logo.png' %}" alt="Logo Dulcer칤a Lili" width="40" height="40">
      </div>
    </div>

    <div class="card-body bg-light">
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">
          {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="prodTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="tab-id" data-bs-toggle="tab" data-bs-target="#pane-id" type="button">1. Identificaci칩n y precios</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-stock" data-bs-toggle="tab" data-bs-target="#pane-stock" type="button">2. Stock y control</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-rel" data-bs-toggle="tab" data-bs-target="#pane-rel" type="button">3. Relaciones y derivados</button>
        </li>
      </ul>

      <form method="post" action="{% url 'productos:crear' %}" id="productoForm" novalidate>
        {% csrf_token %}
        <div class="tab-content">

          <!-- 1) Identificaci칩n y precios -->
          <div class="tab-pane fade show active" id="pane-id" role="tabpanel">
            <div class="row g-3">
              {% for field in form.visible_fields %}
              {% if field.name == 'sku' or field.name == 'ean_upc' or field.name == 'nombre' or field.name == 'descripcion' or field.name == 'categoria' or field.name == 'marca' or field.name == 'modelo' or field.name == 'uom_compra' or field.name == 'uom_venta' or field.name == 'factor_conversion' or field.name == 'costo_estandar' or field.name == 'costo_promedio' or field.name == 'precio_venta' or field.name == 'impuesto_iva' %}
              <div class="col-md-4">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                      {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- 2) Stock y control -->
          <div class="tab-pane fade" id="pane-stock" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-4">{{ form.stock_minimo.label_tag }} {{ form.stock_minimo }}</div>
              <div class="col-md-4">{{ form.stock_maximo.label_tag }} {{ form.stock_maximo }}</div>
              <div class="col-md-4">{{ form.punto_reorden.label_tag }} {{ form.punto_reorden }}</div>
              <div class="col-md-4 form-check mt-4">{{ form.perishable }} <label class="form-check-label">Perishable</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_lote }} <label class="form-check-label">Control por lote</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_serie }} <label class="form-check-label">Control por serie</label></div>
            </div>
          </div>

          <!-- 3) Relaciones y derivados -->
          <div class="tab-pane fade" id="pane-rel" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-6">{{ form.imagen_url.label_tag }} {{ form.imagen_url }}</div>
              <div class="col-md-6">{{ form.ficha_tecnica_url.label_tag }} {{ form.ficha_tecnica_url }}</div>
              <div class="col-md-6">{{ form.stock_actual.label_tag }} {{ form.stock_actual }}</div>
              <div class="col-md-6">
                <label class="form-label"> alerta bajo stock </label>
                <input type="text" class="form-control" value="{% if form.instance.alerta_bajo_stock %}S칤{% else %}No{% endif %}" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Alerta Por Vencer</label>
                <input type="text" class="form-control" 
                       value="{% if form.instance.alerta_por_vencer %}S칤{% else %}No{% endif %}" readonly>
              </div>

            </div>
          </div>

        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="reset" class="btn btn-secondary me-2">
            <i class="bi bi-eraser"></i> Limpiar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-save"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

>>>>>>> 04b2537 (todo casi todo casi casi casi casi todo)
</div>


  <!-- 游 Formulario embebido -->
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background-color:#c62828;">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Formulario de Producto</h4>
        <img src="{% static 'img/logo.png' %}" alt="Logo Dulcer칤a Lili" width="40" height="40">
      </div>
    </div>

    <div class="card-body bg-light">
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">
          {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="prodTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="tab-id" data-bs-toggle="tab" data-bs-target="#pane-id" type="button">1. Identificaci칩n y precios</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-stock" data-bs-toggle="tab" data-bs-target="#pane-stock" type="button">2. Stock y control</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-rel" data-bs-toggle="tab" data-bs-target="#pane-rel" type="button">3. Relaciones y derivados</button>
        </li>
      </ul>

      <form method="post" action="{% url 'productos:crear' %}" id="productoForm" novalidate>
        {% csrf_token %}
        <div class="tab-content">

          <!-- 1) Identificaci칩n y precios -->
          <div class="tab-pane fade show active" id="pane-id" role="tabpanel">
            <div class="row g-3">
              {% for field in form.visible_fields %}
              {% if field.name == 'sku' or field.name == 'ean_upc' or field.name == 'nombre' or field.name == 'descripcion' or field.name == 'categoria' or field.name == 'marca' or field.name == 'modelo' or field.name == 'uom_compra' or field.name == 'uom_venta' or field.name == 'factor_conversion' or field.name == 'costo_estandar' or field.name == 'costo_promedio' or field.name == 'precio_venta' or field.name == 'impuesto_iva' %}
              <div class="col-md-4">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                      {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- 2) Stock y control -->
          <div class="tab-pane fade" id="pane-stock" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-4">{{ form.stock_minimo.label_tag }} {{ form.stock_minimo }} {% if form.stock_minimo.errors %}
                    <div class="text-danger">
                        {{ form.stock_minimo.errors }}
                    </div>
                {% endif %}
            </div>
              <div class="col-md-4">{{ form.stock_maximo.label_tag }} {{ form.stock_maximo }}</div>
              <div class="col-md-4">{{ form.punto_reorden.label_tag }} {{ form.punto_reorden }}</div>
              <div class="col-md-4 form-check mt-4">{{ form.perishable }} <label class="form-check-label">Perishable</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_lote }} <label class="form-check-label">Control por lote</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_serie }} <label class="form-check-label">Control por serie</label></div>
            </div>
          </div>

          <!-- 3) Relaciones y derivados -->
          <div class="tab-pane fade" id="pane-rel" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-6">{{ form.imagen_url.label_tag }} {{ form.imagen_url }}</div>
              <div class="col-md-6">{{ form.ficha_tecnica_url.label_tag }} {{ form.ficha_tecnica_url }}</div>
              <div class="col-md-6">{{ form.stock_actual.label_tag }} {{ form.stock_actual }}</div>
              <div class="col-md-6">
                <label class="form-label"> alerta bajo stock </label>
                <input type="text" class="form-control" value="{% if form.instance.alerta_bajo_stock %}S칤{% else %}No{% endif %}" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Alerta Por Vencer</label>
                <input type="text" class="form-control" 
                       value="{% if form.instance.alerta_por_vencer %}S칤{% else %}No{% endif %}" readonly>
              </div>

            </div>
          </div>

        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="reset" class="btn btn-secondary me-2">
            <i class="bi bi-eraser"></i> Limpiar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-save"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SweetAlert2 para eliminar -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmarEliminacion(id) {
  Swal.fire({
    title: '쮼liminar producto?',
    text: 'Esta acci칩n no se puede deshacer.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S칤, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((r) => { if (r.isConfirmed) window.location.href = `/productos/${id}/eliminar/`; });

}
</script>
{% endblock %}
