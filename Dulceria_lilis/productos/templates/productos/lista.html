{% extends 'usuarios/base.html' %}
{% load static %}

{% block title %}Productos{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-box-seam"></i> Lista de Productos
    </h2>
    <div class="col-md-2 d-grid">
  <a class="btn btn-success" href="?export=xlsx">
    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
  </a>
</div>
  </div>


  <!-- Tabla -->
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      {% if productos %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>SKU</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Precio venta</th>
              <th>Stock actual</th>
              <th>IVA</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pr in productos %}
            <tr>
              <td>{{ pr.sku }}</td>
              <td>{{ pr.nombre }}</td>
              <td>{{ pr.categoria }}</td>
              <td>${{ pr.precio_venta|default:0|floatformat:0 }}</td>
              <td>{{ pr.stock_actual }}</td>
              <td>{{ pr.impuesto_iva }}%</td>
              <td class="text-center">
                <a href="{% url 'productos:editar' pr.pk %}" class="btn btn-sm btn-warning" title="Editar">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'productos:detalle' pr.pk %}" class="btn btn-sm btn-info" title="Detalle">
                  <i class="bi bi-info-circle"></i>
                </a>
                <button onclick="confirmarEliminacion('{{ pr.pk }}')" class="btn btn-sm btn-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="alert alert-info mb-0">No hay productos registrados.</div>
      {% endif %}
    </div>
  </div>

  <!-- üßæ Formulario embebido -->
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background-color:#c62828;">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Formulario de Producto</h4>
        <img src="{% static 'img/logo.png' %}" alt="Logo Dulcer√≠a Lili" width="40" height="40">
      </div>
    </div>

    <div class="card-body bg-light">
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">
          {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="prodTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="tab-id" data-bs-toggle="tab" data-bs-target="#pane-id" type="button">1. Identificaci√≥n y precios</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-stock" data-bs-toggle="tab" data-bs-target="#pane-stock" type="button">2. Stock y control</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="tab-rel" data-bs-toggle="tab" data-bs-target="#pane-rel" type="button">3. Relaciones y derivados</button>
        </li>
      </ul>

      <form method="post" action="{% url 'productos:crear' %}" id="productoForm" novalidate>
        {% csrf_token %}
        <div class="tab-content">

          <!-- 1) Identificaci√≥n y precios -->
          <div class="tab-pane fade show active" id="pane-id" role="tabpanel">
            <div class="row g-3">
              {% for field in form.visible_fields %}
              {% if field.name == 'sku' or field.name == 'ean_upc' or field.name == 'nombre' or field.name == 'descripcion' or field.name == 'categoria' or field.name == 'marca' or field.name == 'modelo' or field.name == 'uom_compra' or field.name == 'uom_venta' or field.name == 'factor_conversion' or field.name == 'costo_estandar' or field.name == 'costo_promedio' or field.name == 'precio_venta' or field.name == 'impuesto_iva' %}
              <div class="col-md-4">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                      {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- 2) Stock y control -->
          <div class="tab-pane fade" id="pane-stock" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-4">{{ form.stock_minimo.label_tag }} {{ form.stock_minimo }}</div>
              <div class="col-md-4">{{ form.stock_maximo.label_tag }} {{ form.stock_maximo }}</div>
              <div class="col-md-4">{{ form.punto_reorden.label_tag }} {{ form.punto_reorden }}</div>
              <div class="col-md-4 form-check mt-4">{{ form.perishable }} <label class="form-check-label">Perishable</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_lote }} <label class="form-check-label">Control por lote</label></div>
              <div class="col-md-4 form-check mt-4">{{ form.control_por_serie }} <label class="form-check-label">Control por serie</label></div>
            </div>
          </div>

          <!-- 3) Relaciones y derivados -->
          <div class="tab-pane fade" id="pane-rel" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-6">{{ form.imagen_url.label_tag }} {{ form.imagen_url }}</div>
              <div class="col-md-6">{{ form.ficha_tecnica_url.label_tag }} {{ form.ficha_tecnica_url }}</div>
              <div class="col-12">{{ form.stock_actual.label_tag }} {{ form.stock_actual }}</div>
            </div>
          </div>

        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="reset" class="btn btn-secondary me-2">
            <i class="bi bi-eraser"></i> Limpiar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-save"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SweetAlert2 para eliminar -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmarEliminacion(id) {
  Swal.fire({
    title: '¬øEliminar producto?',
    text: 'Esta acci√≥n no se puede deshacer.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((r) => { if (r.isConfirmed) window.location.href = `/productos/${id}/eliminar/`; });

}
</script>
{% endblock %}
